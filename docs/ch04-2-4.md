## 버퍼 풀

버퍼 풀은 디스크의 데이터파일이나 인덱스 정보를 메모리에 캐시해 두는 공간이다.

쓰기지연을 통해 버퍼역할도 추가적으로 수행한다.

### 버퍼 풀의 크기설정

버퍼풀은 시스템변수 `innodb_buffer_pool_size`로 크기 설정이 가능하며, 동적으로 버퍼 풀의 크기를 활장할 수 있다.

하지만 버퍼 풀의 크기변경은 크리티컬한 변경이므로 DB가 한가할때 적용시키는 것이 좋고, 사이즈를 줄이는 작업은 왠만하면 피하자.

버퍼풀은 내부적으로 128MB 청크로 나눠져서 관리된다. 따라서 버퍼 풀의 크기를 늘리는것은 128MB씩 늘리는것과 같아진다.

버퍼풀 인스턴스는 버퍼풀을 독립적으로 나눈것을 의미한다. 이로인해 잠금에 대한 분산을 가능케 한다.

### 버퍼풀의 구조

결국 버퍼풀은 여러 버퍼풀 인스턴스로 나뉘고

`버퍼풀 인스턴스` 내에는 `청크`라는 128MB단위로 크기가 결정되고, 한번에 불러오는 데이터의 크기를 결정하는것이 `데이터 페이지`가 된다.

결국 불러온 데이터의 단위가 데이터페이지인데, 여기서 데이터페이지를 관리하는 자료구조가 크게 3가지가 존재한다.

- LRU 리스트: MRU(Most Recently Used)와 LRU(Least Recently Used)를 함께 사용하며 MRU는 NEW 영역, LRU는 OLD 영역이된다. 여기서 DISK로부터 새로 읽어들인 데이터는 MRU와 LRU 사이에 위치하게 된다.

    - 즉, MRU쪽의 헤드와 가까워지면 질수록 자주 사용되는 데이터이고, 그 반대의 데이터는 LRU의 꼬리쪽으로 밀려나다가 결국 지워진다.

- 플러시 리스트: 디스크로 동기화 되지않은 데이터를 가진 데이터 페이지의 변경 시점 기준으 페이지 목록을 관리한다. 

    - 즉, 변경을 일으킨 데이터 페이지를 관리하며 특정시점에 디스크로 플러시됨.

    - 변경이 발생하면 리두로그(Redo Log)라는데에도 같이 기록됨

- 프리 리스트


### 버퍼 풀과 리두로그

버퍼 풀의 크기는 데이터의 캐싱과 관련되어 있고 DISK I/O를 줄여준다.

하지만 이것이 데이터 캐싱능력을 키워 줄 뿐이지 버퍼링 기능까지 향상 시키진 않는다.

왜냐하면 리두로그의 기능과 버퍼풀의 기능의 밀접한 관계 때문이다.

우선 변경점이 발생하면 리두로그에도 기록하고 더티페이지에도 기록하는데

여기서 해당 변경점이 발생한 지점에 또다른 변경점이 발생했다고 하자.

버퍼풀에서는 그냥 "그지점에서 또 변경됬구나" 싶어서 덮어씌우지만, 리두로그는 순환구조로 인해 계속해서 새로운 리두 엔트리를 쓰게된다.

그럼 이전에 썻엇던 기록은 쓸모가없으므로 재사용가능한 상태가 되고, 새롭게 쓴 엔트리는 재사용 불가능한 상태 즉 `활성 리두로그 공간`이 된다.

어쨋든 이런상황에서 리두로그 공간은 LSN이라는 인덱스넘버가 부여되어 있는데, 이는 순환과는 상관없이 계속해서 증가하는 값이다.

그러다가 일정주기를 맞이하거나 `꽉차면` `체크포인트` 라는 이벤트를 발생시키는데, 이 때 해당 체크포인트 이전의 엔트리들 중 `활성 리두로그 공간`에 속하는 데이터페이지에 대해서 디스크로 옮겨진다.

이 때 연관된 페이지가 있는 더티페이지속 데이터페이지부터 디스크로 옮기고 그다음 리두로그가 디스크로 옮겨진다.

그래서 리두 로그 파일의 크기를 적당히 설정하여 버퍼링 능력도 최적화 해야한다.

### 버퍼풀 플러시

버퍼풀에는 플러시를 해야하는 자료구조가 두가지 있다.

- 플러시 리스트 플러시

    - 기본적으로 버퍼 풀 인스턴스당 하나의 더티페이지 정리를 위한 클리너 스레드를 가진다.

    - 더티 페이지의 양과 더티 페이지를 디스크로 옮기는 양을 적절히 조절하자.

    - 디스크로 쓰는 양을 수동으로 조절하기 힘들다면 어뎁티브 플러시 기능을 켜자.

- LRU 리스트 플러시

    - LRU 리스트 플러시는 자주 안읽어지는 데이터페이지에 대해서 더티페이지의 경우 디스크에 동기화 하게 하고, 클린 페이지의 경우엔 프리리스트로 옮겨진다.

이들 두 가지 자료구조를 백그라운드에서 플러시한다.

### 버퍼풀 상태 백업 및 복구

버퍼 풀은 쿼리 처리성능과 굉장히 관련이 있다. (버퍼링 기능과 캐싱기능을 제공하기 때문)

그래서 버퍼 풀이 싹다 비워진체로 시작하는 초기시작 혹은 재부팅의 경우, 원래의 쿼리성능보다 1/10 수준으로 떨어질 수 있다.

이런상황을 대비해 버퍼풀에 일부 데이터를 넣어놓은체로 시작하는것을 `워밍업`이라고 한다.

5.5 버전에서는 테이블에 인덱스에 대해서 풀 스캔을 때리는 방식으로 워밍업 하였다.

5.6 이후부터는 버퍼풀을 별도로 백업해놓는 방식으로 다음에 켤때 백업된 내용을 불러올 수 있다.

하지만 이 기능에서 주의할 점은 저장은 메타데이터만 저장하기에 빠르지만 불러올때에는 디스크에서 불러오기에 상당히 느릴 수 있다.
