## 내부 임시 테이블 활용

여기서 왜 "내부" 임시 테이블일까?

사용자가 임의로 생성하는 임시 테이블과는 구분짓기 위해서 내부라는 키워드를 붙인다.

이렇게 생성되는 임시테이블은 일반적으로 `ls -al`과 같은 명령어로 조회할 수 없다.

왜냐하면 생성과 동시에 삭제를 걸어놓기 때문이다. 

```
운영체제에서 일반적으로 생성된 파일에 대한 삭제는 해당 파일을 사용하고있는 프로세스들이 모두 종료된 후에 삭제된다.

따라서 MySQL서버가 종료되거나 쿼리가 실행종료되면 자동으로 삭제되어서 안보이게 되는 원리를 사용한 것
```

### 메모리 기반 임시테이블과 디스크 기반 임시테이블

메모리 기반 임시테이블은 옛날에는 VARCHAR 가 지원안되는 엔진을 사용했엇어서 비효율적이었지만

이제는 VARCHAR를 지원하는 임시테이블을 사용할 수 있다.

디스크 기반 임시테이블도 옛날에는 트랜잭션을 지원안하는 MyISAM 엔진이었으나, 이제는 트랜잭션 지원가능한 엔진들이 도입되어 있다.

크게는 InnoDB 와 MMAP 파일버전으로 나뉜다.

처음에는 임시테이블을 메모리기반으로 최대한 적제하다가, 그 임계값을 넘어버리면 디스크기반으로 바뀐다.

기본 설정값에 의하면 메모리 한계점은 1GB이며, 이 한계점을 넘어서면 시스템 변수에 의해 TempTable (MMAP파일 기반) 혹은 InnoDB 테이블로 전환된다.

여기서도 기본 설정으로는 InnoDB 테이블로의 전환이 오버헤드가 크기 때문에 TempTable 기반으로 전한된다.

### 임시테이블이 필요한 쿼리

다음의 쿼리들은 임시테이블을 사용하는 패턴이라고 보면 된다.

- ORDER BY 와 GROUP BY에 사용된 컬럼이 서로 다른경우

- ORDER BY 와 GROUP BY에 명시된 컬럼이 조인의 순서상 첫 번째 테이블에 속해있지 않은 경우

- DISTINCT와 ORDER BY가 동시에 존재하는 경우 혹은 DISTINCT가 인덱스로 처리되지 못하는 경우

- UNION이나 UNION DISTINCT가 사용된 쿼리(select_type 칼럼이 UNION RESULT인 경우)

- 쿼리의 실행계획에서 select_type이 DERIVED인 쿼리

물론 쿼리앞에 `explain` 키워드를 붙여서 `Extra` 컬럼에 `Using temporary`가 들어있는지 확인하면 되지만

`아래의 3개의 경우에서는 실행계획에 표시되지 않는다.`

또한 `1 ~ 4번의 경우에서는 내부적으로 임시테이블을 만들 때 유니크 인덱스`가 걸려있게 되어 

중복 제거 처리를 위한 오버헤드가 다른 임시테이블에 비해 비쌀 수 있다.




